<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Devices - PioSystem</title>
    <link href="/assets/bootstrap.min.css" rel="stylesheet">
    <style>
        .device-card {
            border-left: 4px solid #007bff;
        }
        .device-card.online {
            border-left-color: #28a745;
        }
        .device-card.offline {
            border-left-color: #dc3545;
        }
        .status-badge {
            font-size: 0.8em;
        }
        .device-type {
            font-weight: 600;
            color: #495057;
        }
        .refresh-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">PioSystem</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">Dashboard</a>
                <a class="nav-link" href="/wifi-config">WiFi</a>
                <a class="nav-link active" href="/iot-devices">IoT Devices</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>IoT Devices</h2>
                    <div>
                        <button class="btn btn-outline-primary" onclick="refreshDevices()">
                            <span id="refresh-icon" class="me-2">üîÑ</span>
                            Refresh
                        </button>
                        <button class="btn btn-outline-secondary" onclick="toggleDiscovery()" id="discovery-btn">
                            <span id="discovery-status">‚è∏Ô∏è Stop Discovery</span>
                        </button>
                    </div>
                </div>

                <!-- Discovery Status -->
                <div class="alert alert-info" id="discovery-info">
                    <div class="d-flex justify-content-between">
                        <span>Discovery Status: <strong id="discovery-active">Active</strong></span>
                        <span>Total Scans: <strong id="scan-count">0</strong></span>
                    </div>
                </div>

                <!-- Device List -->
                <div id="device-list">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Discovering IoT devices...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/assets/bootstrap.bundle.js"></script>
    <script>
        let discoveryActive = true;

        function formatUptime(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) {
                return `${days}d ${hours % 24}h ${minutes % 60}m`;
            } else if (hours > 0) {
                return `${hours}h ${minutes % 60}m`;
            } else {
                return `${minutes}m ${seconds % 60}s`;
            }
        }

        function getDeviceTypeIcon(type) {
            const icons = {
                'ESP32_CAMERA': 'üì∑',
                'ESP32_SENSOR': 'üå°Ô∏è',
                'ESP32_CONTROLLER': 'üéõÔ∏è',
                'ESP32_DISPLAY': 'üì∫',
                'RASPBERRY_PI': 'ü•ß',
                'ARDUINO_IOT': 'üîß',
                'CUSTOM_DEVICE': 'üì±',
                'UNKNOWN': '‚ùì'
            };
            return icons[type] || '‚ùì';
        }

        function renderDeviceCard(device) {
            const uptime = device.lastSeen ? formatUptime(Date.now() - device.discoveredAt) : 'Unknown';
            const statusBadge = device.isOnline ? 
                '<span class="badge bg-success status-badge">ONLINE</span>' :
                '<span class="badge bg-danger status-badge">OFFLINE</span>';
            
            const cardClass = device.isOnline ? 'online' : 'offline';
            const deviceName = device.name || device.hostname || device.ipAddress;
            
            return `
                <div class="card device-card ${cardClass} mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="card-title">
                                    ${getDeviceTypeIcon(device.type)} ${deviceName}
                                    ${statusBadge}
                                </h5>
                                <div class="device-type">${device.type.replace('_', ' ')}</div>
                                <p class="card-text text-muted mb-2">
                                    <small>
                                        IP: ${device.ipAddress}<br>
                                        MAC: ${device.macAddress}<br>
                                        Discovered: ${uptime} ago
                                    </small>
                                </p>
                            </div>
                            <div class="text-end">
                                ${device.hasHttpServer ? '<span class="badge bg-info">HTTP</span>' : ''}
                                ${device.capabilities && device.capabilities.length > 0 ? 
                                    device.capabilities.map(cap => `<span class="badge bg-secondary me-1">${cap}</span>`).join('') : 
                                    ''}
                            </div>
                        </div>
                        
                        ${device.baseUrl ? `
                            <div class="mt-3">
                                <a href="${device.baseUrl}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    Open Device Interface
                                </a>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function loadDevices() {
            fetch('/api/v1/iot/devices')
                .then(response => response.json())
                .then(data => {
                    const deviceList = document.getElementById('device-list');
                    
                    if (data.success && data.devices && data.devices.length > 0) {
                        deviceList.innerHTML = data.devices.map(renderDeviceCard).join('');
                    } else {
                        deviceList.innerHTML = `
                            <div class="text-center py-5">
                                <h5 class="text-muted">No IoT devices found</h5>
                                <p class="text-muted">Make sure devices are connected to the hotspot and have HTTP servers running on port 80.</p>
                                <button class="btn btn-primary" onclick="refreshDevices()">Scan for Devices</button>
                            </div>
                        `;
                    }
                    
                    // Update discovery status
                    if (data.discoveryStatus) {
                        document.getElementById('discovery-active').textContent = 
                            data.discoveryStatus.active ? 'Active' : 'Inactive';
                        document.getElementById('scan-count').textContent = 
                            data.discoveryStatus.scanCount || 0;
                        discoveryActive = data.discoveryStatus.active;
                        updateDiscoveryButton();
                    }
                })
                .catch(error => {
                    console.error('Error loading devices:', error);
                    document.getElementById('device-list').innerHTML = `
                        <div class="alert alert-danger">
                            <h5>Error loading devices</h5>
                            <p>Failed to fetch device list. Please try refreshing the page.</p>
                        </div>
                    `;
                });
        }

        function refreshDevices() {
            const refreshIcon = document.getElementById('refresh-icon');
            refreshIcon.classList.add('refresh-spinner');
            
            fetch('/api/v1/iot/scan', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Wait a moment for scan to complete, then reload
                        setTimeout(loadDevices, 2000);
                    }
                })
                .catch(error => console.error('Error triggering scan:', error))
                .finally(() => {
                    setTimeout(() => {
                        refreshIcon.classList.remove('refresh-spinner');
                    }, 2000);
                });
        }

        function toggleDiscovery() {
            const endpoint = discoveryActive ? '/api/v1/iot/discovery/stop' : '/api/v1/iot/discovery/start';
            
            fetch(endpoint, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        discoveryActive = !discoveryActive;
                        updateDiscoveryButton();
                        loadDevices(); // Refresh status
                    }
                })
                .catch(error => console.error('Error toggling discovery:', error));
        }

        function updateDiscoveryButton() {
            const btn = document.getElementById('discovery-btn');
            const status = document.getElementById('discovery-status');
            
            if (discoveryActive) {
                status.textContent = '‚è∏Ô∏è Stop Discovery';
                btn.className = 'btn btn-outline-warning';
            } else {
                status.textContent = '‚ñ∂Ô∏è Start Discovery';
                btn.className = 'btn btn-outline-success';
            }
        }

        // Load devices on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDevices();
            
            // Auto-refresh every 30 seconds
            setInterval(loadDevices, 30000);
        });
    </script>
</body>
</html>
