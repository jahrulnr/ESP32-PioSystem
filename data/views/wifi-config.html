<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PioSystem - WiFi Configuration</title>
    <link rel="stylesheet" href="/assets/bootstrap.min.css">
    <style>
        body {
            padding-top: 20px;
        }
        .card {
            margin-bottom: 20px;
        }
        .network-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .network-item:hover {
            background-color: #f8f9fa;
        }
        .network-item.selected {
            background-color: #e9ecef;
        }
        .signal-strength {
            display: inline-block;
            width: 20px;
            height: 20px;
            text-align: center;
            border-radius: 50%;
            color: white;
            font-weight: bold;
        }
        .signal-high {
            background-color: #28a745;
        }
        .signal-medium {
            background-color: #ffc107;
        }
        .signal-low {
            background-color: #dc3545;
        }
        .navbar-brand img {
            height: 30px;
            margin-right: 10px;
        }
        .saved-network {
            border-left: 4px solid #28a745;
        }
        #connection-status {
            position: fixed;
            top: 60px;
            right: 10px;
            z-index: 1000;
        }
        .password-toggle {
            cursor: pointer;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <span>PioSystem WiFi Configuration</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/" id="nav-dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/wifi-config" id="nav-wifi-config">WiFi Config</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/settings" id="nav-settings">Settings</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="connection-status" class="alert alert-success d-none">
        Connected to server
    </div>

    <div class="container mt-4">
        <div class="row">
            <!-- Saved Networks -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Saved Networks</h5>
                        <button class="btn btn-sm btn-primary" id="refresh-saved">Refresh</button>
                    </div>
                    <div class="card-body">
                        <div id="saved-networks-list">Loading...</div>
                    </div>
                </div>

                <!-- Current Connection -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Current Connection</h5>
                    </div>
                    <div class="card-body">
                        <div id="current-connection">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Available Networks -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Available Networks</h5>
                        <button class="btn btn-sm btn-primary" id="scan-networks">Scan</button>
                    </div>
                    <div class="card-body">
                        <div id="network-list">
                            <p class="text-center">Click "Scan" to search for available networks</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Connect to Network Modal -->
    <div class="modal fade" id="connect-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Connect to Network</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="connect-form">
                        <div class="mb-3">
                            <label for="ssid" class="form-label">SSID</label>
                            <input type="text" class="form-control" id="ssid" name="ssid" readonly>
                        </div>
                        <div class="mb-3 position-relative">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password">
                            <span class="password-toggle" onclick="togglePasswordVisibility()">
                                <i class="bi bi-eye"></i>
                            </span>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="save-network" name="save" checked>
                            <label class="form-check-label" for="save-network">Save this network</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="connect-btn">Connect</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Manual Network Modal -->
    <div class="modal fade" id="add-network-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Network Manually</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-network-form">
                        <div class="mb-3">
                            <label for="manual-ssid" class="form-label">SSID</label>
                            <input type="text" class="form-control" id="manual-ssid" name="ssid" required>
                        </div>
                        <div class="mb-3 position-relative">
                            <label for="manual-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="manual-password" name="password">
                            <span class="password-toggle" onclick="toggleManualPasswordVisibility()">
                                <i class="bi bi-eye"></i>
                            </span>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="add-network-btn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/assets/bootstrap.bundle.js"></script>
    <script>
        // DOM elements
        const savedNetworksList = document.getElementById('saved-networks-list');
        const currentConnection = document.getElementById('current-connection');
        const networkList = document.getElementById('network-list');
        const refreshSavedBtn = document.getElementById('refresh-saved');
        const scanNetworksBtn = document.getElementById('scan-networks');
        const connectModal = new bootstrap.Modal(document.getElementById('connect-modal'));
        const addNetworkModal = new bootstrap.Modal(document.getElementById('add-network-modal'));
        const connectForm = document.getElementById('connect-form');
        const addNetworkForm = document.getElementById('add-network-form');
        const connectBtn = document.getElementById('connect-btn');
        const addNetworkBtn = document.getElementById('add-network-btn');
        const connectionStatus = document.getElementById('connection-status');
        
        // Variables to store selected network
        let selectedNetwork = null;
        
        // Event listeners
        refreshSavedBtn.addEventListener('click', loadSavedNetworks);
        scanNetworksBtn.addEventListener('click', scanNetworks);
        connectBtn.addEventListener('click', connectToNetwork);
        addNetworkBtn.addEventListener('click', addNetworkManually);
        
        // Password visibility toggle
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
        }
        
        function toggleManualPasswordVisibility() {
            const passwordInput = document.getElementById('manual-password');
            passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
        }
        
        // WebSocket connection
        let ws;
        function connectWebSocket() {
            ws = new WebSocket(`ws://${window.location.hostname}/ws/wifi`);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                connectionStatus.textContent = 'Connected to server';
                connectionStatus.classList.remove('d-none', 'alert-danger');
                connectionStatus.classList.add('alert-success');
                setTimeout(() => {
                    connectionStatus.classList.add('d-none');
                }, 3000);
                
                // Subscribe to updates
                ws.send(JSON.stringify({
                    command: 'subscribe',
                    topic: 'wifi-status'
                }));
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                connectionStatus.textContent = 'Disconnected from server';
                connectionStatus.classList.remove('d-none', 'alert-success');
                connectionStatus.classList.add('alert-danger');
                
                // Try to reconnect after 5 seconds
                setTimeout(connectWebSocket, 5000);
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'wifi-status') {
                        updateCurrentConnection(data);
                    } else if (data.type === 'network-scan') {
                        updateNetworkList(data.networks);
                    }
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };
        }
        
        // API functions
        async function loadSavedNetworks() {
            try {
                const response = await fetch('/api/wifi/config');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data.status === 'success') {
                    displaySavedNetworks(data.networks);
                    
                    if (data.current_connection) {
                        displayCurrentConnection(data.current_connection);
                    } else {
                        currentConnection.innerHTML = `<div class="alert alert-info">Not connected to any network</div>`;
                    }
                } else {
                    savedNetworksList.innerHTML = `<div class="alert alert-danger">Error: ${data.message || 'Unknown error'}</div>`;
                }
            } catch (error) {
                console.error('Error loading saved networks:', error);
                savedNetworksList.innerHTML = `<div class="alert alert-danger">Error loading networks: ${error.message}</div>`;
            }
        }
        
        async function scanNetworks() {
            try {
                scanNetworksBtn.disabled = true;
                scanNetworksBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Scanning...';
                networkList.innerHTML = '<p class="text-center">Scanning for networks...</p>';
                
                const response = await fetch('/api/wifi/scan', {
                    method: 'POST'
                });
                
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayNetworks(data.networks);
                } else {
                    networkList.innerHTML = `<div class="alert alert-danger">Error: ${data.message || 'No networks found'}</div>`;
                }
            } catch (error) {
                console.error('Error scanning networks:', error);
                networkList.innerHTML = `<div class="alert alert-danger">Error scanning networks: ${error.message}</div>`;
            } finally {
                scanNetworksBtn.disabled = false;
                scanNetworksBtn.textContent = 'Scan';
            }
        }
        
        async function connectToNetwork() {
            try {
                const formData = new FormData(connectForm);
                const data = {
                    ssid: formData.get('ssid'),
                    password: formData.get('password'),
                    save: formData.get('save') === 'on'
                };
                
                connectBtn.disabled = true;
                connectBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Connecting...';
                
                const response = await fetch('/api/wifi/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showAlert('success', `Connected to ${data.ssid} successfully`);
                    connectModal.hide();
                    
                    // Refresh saved networks and current connection
                    loadSavedNetworks();
                } else {
                    showAlert('danger', result.message || 'Failed to connect to network');
                }
            } catch (error) {
                console.error('Error connecting to network:', error);
                showAlert('danger', `Error connecting to network: ${error.message}`);
            } finally {
                connectBtn.disabled = false;
                connectBtn.textContent = 'Connect';
            }
        }
        
        async function connectToSavedNetwork(networkId) {
            try {
                const response = await fetch(`/api/wifi/config/${networkId}/connect`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showAlert('success', result.message || 'Connected to network successfully');
                    
                    // Refresh saved networks and current connection
                    loadSavedNetworks();
                } else {
                    showAlert('danger', result.message || 'Failed to connect to network');
                }
            } catch (error) {
                console.error('Error connecting to saved network:', error);
                showAlert('danger', `Error connecting to network: ${error.message}`);
            }
        }
        
        async function deleteSavedNetwork(networkId, ssid) {
            if (!confirm(`Are you sure you want to delete the saved network "${ssid}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/wifi/config/${networkId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showAlert('success', result.message || 'Network deleted successfully');
                    
                    // Refresh saved networks
                    loadSavedNetworks();
                } else {
                    showAlert('danger', result.message || 'Failed to delete network');
                }
            } catch (error) {
                console.error('Error deleting network:', error);
                showAlert('danger', `Error deleting network: ${error.message}`);
            }
        }
        
        async function addNetworkManually() {
            try {
                const formData = new FormData(addNetworkForm);
                const data = {
                    ssid: formData.get('ssid'),
                    password: formData.get('password')
                };
                
                if (!data.ssid) {
                    showAlert('danger', 'SSID is required');
                    return;
                }
                
                addNetworkBtn.disabled = true;
                addNetworkBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
                
                const response = await fetch('/api/wifi/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showAlert('success', `Network ${data.ssid} saved successfully`);
                    addNetworkModal.hide();
                    
                    // Clear the form
                    addNetworkForm.reset();
                    
                    // Refresh saved networks
                    loadSavedNetworks();
                } else {
                    showAlert('danger', result.message || 'Failed to save network');
                }
            } catch (error) {
                console.error('Error adding network:', error);
                showAlert('danger', `Error adding network: ${error.message}`);
            } finally {
                addNetworkBtn.disabled = false;
                addNetworkBtn.textContent = 'Save';
            }
        }
        
        // Helper functions
        function displaySavedNetworks(networks) {
            if (!networks || networks.length === 0) {
                savedNetworksList.innerHTML = `
                    <div class="alert alert-info">No saved networks</div>
                    <button class="btn btn-sm btn-success" onclick="openAddNetworkModal()">Add Network Manually</button>
                `;
                return;
            }
            
            let html = '<div class="list-group">';
            
            networks.forEach(network => {
                html += `
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${network.ssid}</h6>
                            <small class="text-muted">Saved Network</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-primary me-2" onclick="connectToSavedNetwork('${network.id}')">Connect</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSavedNetwork('${network.id}', '${network.ssid}')">Delete</button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<div class="mt-3">';
            html += '<button class="btn btn-sm btn-success" onclick="openAddNetworkModal()">Add Network Manually</button>';
            html += '</div>';
            
            savedNetworksList.innerHTML = html;
        }
        
        function displayCurrentConnection(connection) {
            if (!connection || !connection.ssid) {
                currentConnection.innerHTML = `<div class="alert alert-info">Not connected to any network</div>`;
                return;
            }
            
            let html = '<ul class="list-group">';
            
            html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                SSID
                <span class="badge bg-primary">${connection.ssid}</span>
            </li>`;
            
            html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                IP Address
                <span class="badge bg-secondary">${connection.ip || 'Unknown'}</span>
            </li>`;
            
            if (connection.rssi) {
                let signalStrength = 'Unknown';
                let signalClass = 'bg-secondary';
                
                if (connection.rssi > -50) {
                    signalStrength = 'Excellent';
                    signalClass = 'bg-success';
                } else if (connection.rssi > -65) {
                    signalStrength = 'Good';
                    signalClass = 'bg-info text-dark';
                } else if (connection.rssi > -75) {
                    signalStrength = 'Fair';
                    signalClass = 'bg-warning text-dark';
                } else {
                    signalStrength = 'Poor';
                    signalClass = 'bg-danger';
                }
                
                html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    Signal Strength
                    <span class="badge ${signalClass}">${signalStrength} (${connection.rssi} dBm)</span>
                </li>`;
            }
            
            if (connection.mac) {
                html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    MAC Address
                    <span class="badge bg-secondary">${connection.mac}</span>
                </li>`;
            }
            
            html += '</ul>';
            
            currentConnection.innerHTML = html;
        }
        
        function displayNetworks(networks) {
            if (!networks || networks.length === 0) {
                networkList.innerHTML = `<div class="alert alert-info">No networks found</div>`;
                return;
            }
            
            let html = '<div class="list-group">';
            
            networks.forEach(network => {
                // Determine signal strength icon
                let signalIcon = '';
                let signalClass = '';
                
                if (network.rssi > -50) {
                    signalIcon = '<i class="bi bi-wifi"></i>';
                    signalClass = 'text-success';
                } else if (network.rssi > -65) {
                    signalIcon = '<i class="bi bi-wifi-2"></i>';
                    signalClass = 'text-info';
                } else if (network.rssi > -75) {
                    signalIcon = '<i class="bi bi-wifi-1"></i>';
                    signalClass = 'text-warning';
                } else {
                    signalIcon = '<i class="bi bi-wifi"></i>';
                    signalClass = 'text-danger';
                }
                
                const savedClass = network.saved ? 'saved-network' : '';
                const connectedClass = network.connected ? 'bg-light' : '';
                
                html += `
                    <div class="list-group-item list-group-item-action ${savedClass} ${connectedClass}" onclick="selectNetwork('${network.ssid}', ${network.encryption !== 0})">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${network.ssid} ${network.connected ? '<span class="badge bg-success">Connected</span>' : ''}</h6>
                                <small class="text-muted">
                                    ${network.encryption !== 0 ? '<i class="bi bi-lock-fill"></i> Secured' : '<i class="bi bi-unlock-fill"></i> Open'} 
                                    ${network.saved ? '<span class="badge bg-info">Saved</span>' : ''}
                                </small>
                            </div>
                            <span class="${signalClass}">${signalIcon} ${network.rssi} dBm</span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            networkList.innerHTML = html;
        }
        
        function selectNetwork(ssid, isSecured) {
            selectedNetwork = { ssid, isSecured };
            
            // Open the connect modal
            document.getElementById('ssid').value = ssid;
            document.getElementById('password').value = '';
            
            // If open network, hide password field
            const passwordField = document.getElementById('password').parentNode;
            passwordField.style.display = isSecured ? 'block' : 'none';
            
            connectModal.show();
        }
        
        function openAddNetworkModal() {
            document.getElementById('manual-ssid').value = '';
            document.getElementById('manual-password').value = '';
            addNetworkModal.show();
        }
        
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Insert at the top of the container
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 150);
            }, 5000);
        }
        
        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            loadSavedNetworks();
            connectWebSocket();
        });
    </script>
</body>
</html>
